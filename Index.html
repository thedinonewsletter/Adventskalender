import tkinter as tk
from tkinter import simpledialog, messagebox
from datetime import datetime
import json
import requests
import os

QUESTIONS = {
    1: "Frage für den 1. Dezember",
    2: "Frage für den 2. Dezember",
    # ...
    24: "Frage für den 24. Dezember"
}

DATA_FILE = "answers_local.json"
API_URL = "https://dein-backend.de/api/answer"

def load_local_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {"name": "", "answers": {}}

def save_local_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def main():
    data = load_local_data()

    root = tk.Tk()
    root.title("Adventskalender-Quiz")

    # Name abfragen
    if not data["name"]:
        name = simpledialog.askstring("Name", "Bitte gib deinen Namen ein:", parent=root)
        if not name:
            root.destroy()
            return
        data["name"] = name
        save_local_data(data)

    today = datetime.now()
    if today.month != 12:
        messagebox.showinfo("Hinweis", "Der Adventskalender ist für Dezember gedacht.")
    today_day = today.day

    frame = tk.Frame(root)
    frame.pack(padx=10, pady=10)

    def open_door(day):
        if day > today_day:
            messagebox.showinfo("Zu früh", "Dieses Türchen ist noch nicht freigeschaltet.")
            return

        if str(day) in data["answers"]:
            if not messagebox.askyesno("Schon beantwortet",
                                       "Du hast dieses Türchen schon beantwortet.\nNochmal antworten?"):
                return

        question = QUESTIONS.get(day, "Keine Frage hinterlegt.")
        answer = simpledialog.askstring(f"Türchen {day}", question, parent=root)
        if not answer:
            return

        # lokal speichern
        data["answers"][str(day)] = answer
        save_local_data(data)

        # an Server senden
        try:
            resp = requests.post(API_URL, json={
                "name": data["name"],
                "day": day,
                "answer": answer
            }, timeout=5)
            if resp.status_code != 200:
                messagebox.showerror("Fehler",
                                     f"Server hat einen Fehler gemeldet ({resp.status_code}). "
                                     "Antwort wird lokal gespeichert.")
            else:
                messagebox.showinfo("Danke", "Antwort gespeichert!")
        except Exception:
            messagebox.showerror("Netzwerkfehler",
                                 "Antwort konnte nicht an den Server gesendet werden.\n"
                                 "Sie bleibt lokal gespeichert.")

    # Türen als Buttons
    for day in range(1, 25):
        btn = tk.Button(frame, text=str(day), width=5,
                        command=lambda d=day: open_door(d))
        row = (day - 1) // 6
        col = (day - 1) % 6
        btn.grid(row=row, column=col, padx=3, pady=3)

        if day > today_day:
            btn.config(state="disabled")

    root.mainloop()

if __name__ == "__main__":
    main()
